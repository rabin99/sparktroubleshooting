# 4.性能调优之在实际项目中广播大变量

场景：这种默认的，task执行的算子中，使用了外部的变量，每个task都会获取一份变量的副本，有什么缺点呢？在什么情况下，会出现性能上的恶劣的影响呢？

> 假设需要使用一个外部变量，是个map对象，10M。
>
> 调优、资源、并行度都分配足够，有1000个task，大量task在并行运行。task都用到这个map，那么map会被拷贝1000份副本，通过网络传输到task中去，给对应task使用，那么就产生接近10G的网络传输。

对性能会有什么影响呢？

> 不必要的内存的消耗和占用，就导致了，你在进行RDD持久化到内存，也许就没法完全在内存中放下；就只能写入磁盘，最后导致后续的操作在磁盘IO上消耗性能；
> 你的task在创建对象的时候，也许会发现堆内存放不下所有对象，也许就会导致频繁的垃圾回收器的回收，GC。GC的时候，一定是会导致工作线程停止，也就是导致Spark暂停工作那么一点时间。频繁GC的话，对Spark作业的运行的速度会有相当可观的影响。

**办法：**

使用广播变量
> 广播变量的好处，不 是每个task一份变量副本，而是变成每个节点的executor才一份副本。这样的话，就可以让变量产生的副本大大减少。

广播变量，在driver上会有一份初始的副本

task在运行的时候，想要使用广播变量中的数据，此时首先会在自己本地的Executor对应的BlockManager中，尝试获取变量副本；如果本地没有，那么就从Driver远程拉取变量副本，并保存在本地的BlockManager中；此后这个executor上的task，都会直接使用本地的BlockManager中的副本。

executor的BlockManager除了从driver上拉取，也可能从其他节点的BlockManager上拉取变量副本，越近越好。

BlockManager

> 负责管理某个Executor对应的内存和磁盘上的数据
>
> BlockManager，也许会从远程的Driver上面去获取变量副本；也有可能从距离比较近的其他节点的Executor的BlockManager上去获取

补充：

大部分会说一个节点一份广播变量，是因为一个节点大部分都是一个executor。

实际应该是每一个节点上的每一个executor对应的BlockManager有一份数据副本。